{% extends 'base.html' %}

{% block title %}æ¸¬ç«™åˆ—è¡¨ - æµ·æ´‹ç›£æ¸¬ç³»çµ±{% endblock %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- æ¸¬ç«™åœ°åœ–ç¸½è¦½ -->
<div class="card">
    <h2>ğŸ—ºï¸ æ¸¬ç«™ä½ç½®ç¸½è¦½</h2>
    <div id="stationsMap" style="height: 400px; border-radius: 8px; border: 2px solid #dee2e6; margin-bottom: 20px;"></div>
</div>

<div class="card">
    <h2>ğŸ“ æ¸¬ç«™åˆ—è¡¨</h2>
    <table>
        <thead>
            <tr>
                <th>æ¸¬ç«™åç¨±</th>
                <th>è¨­å‚™å‹è™Ÿ</th>
                <th>è£è¨­åœ°é»</th>
                <th>åº§æ¨™</th>
                <th>è£è¨­æ—¥æœŸ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for station in stations %}
            <tr>
                <td>{{ station.station_name }}</td>
                <td>{{ station.device_model }}</td>
                <td>{{ station.location }}</td>
                <td>
                    {% if station.latitude and station.longitude %}
                        {{ station.latitude }}, {{ station.longitude }}
                    {% else %}
                        <span style="color: #999;">æœªè¨­å®š</span>
                    {% endif %}
                </td>
                <td>{{ station.install_date }}</td>
                <td><a href="{% url 'station_data:station_detail' station.id %}">æŸ¥çœ‹è©³æƒ…</a></td>
            </tr>
            {% empty %}
            <tr><td colspan="6" style="text-align:center; color:#999;">å°šç„¡æ¸¬ç«™è³‡æ–™</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// åˆå§‹åŒ–æ¸¬ç«™ç¸½è¦½åœ°åœ–
document.addEventListener('DOMContentLoaded', function() {
    // æ”¶é›†æ‰€æœ‰æœ‰åº§æ¨™çš„æ¸¬ç«™
    const stations = [
        {% for station in stations %}
        {% if station.latitude and station.longitude %}
        {
            id: {{ station.id }},
            name: "{{ station.station_name }}",
            location: "{{ station.location }}",
            lat: parseFloat('{{ station.latitude }}'),
            lng: parseFloat('{{ station.longitude }}')
        },
        {% endif %}
        {% endfor %}
    ];

    if (stations.length > 0) {
        // è¨ˆç®—åœ°åœ–ä¸­å¿ƒé»
        const avgLat = stations.reduce((sum, s) => sum + s.lat, 0) / stations.length;
        const avgLng = stations.reduce((sum, s) => sum + s.lng, 0) / stations.length;

        // å‰µå»ºåœ°åœ–
        const map = L.map('stationsMap').setView([avgLat, avgLng], 10);

        // æ·»åŠ  OpenStreetMap åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // ç‚ºæ¯å€‹æ¸¬ç«™æ·»åŠ æ¨™è¨˜
        stations.forEach(station => {
            const marker = L.marker([station.lat, station.lng]).addTo(map);
            marker.bindPopup(`
                <b>${station.name}</b><br>
                ${station.location}<br>
                <a href="/stations/${station.id}/" style="color: #007bff;">æŸ¥çœ‹è©³æƒ… â†’</a>
            `);
        });

        // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
        if (stations.length > 1) {
            const bounds = L.latLngBounds(stations.map(s => [s.lat, s.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    } else {
        // å¦‚æœæ²’æœ‰åº§æ¨™,é¡¯ç¤ºæç¤º
        document.getElementById('stationsMap').innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 16px;">' +
            'å°šç„¡æ¸¬ç«™åº§æ¨™è³‡æ–™,è«‹åœ¨ç®¡ç†å¾Œå°è¨­å®šæ¸¬ç«™ä½ç½®' +
            '</div>';
    }
});
</script>
{% endblock %}
