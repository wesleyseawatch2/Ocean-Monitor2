{% extends 'base.html' %}
{% load static %}

{% block title %}{{ station.station_name }} - æµ·æ´‹ç›£æ¸¬ç³»çµ±{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'realtime/realtime.css' %}">

<div class="card">
    <h2>ğŸŒŠ {{ station.station_name }}</h2>
    <p><strong>è¨­å‚™å‹è™Ÿï¼š</strong>{{ station.device_model }}</p>
    <p><strong>è£è¨­åœ°é»ï¼š</strong>{{ station.location }}</p>
    <p><strong>è£è¨­æ—¥æœŸï¼š</strong>{{ station.install_date }}</p>
    <p><strong>æ•¸æ“šç­†æ•¸ï¼š</strong><span id="total-reading-count">{{ total_count }}</span> ç­†</p>
</div>

<!-- å¯¦æ™‚æ•¸æ“šå®¹å™¨ - JavaScript æœƒåœ¨æ­¤æ’å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div id="realtime-container" data-station-id="{{ station.id }}"></div>

<!-- æœ€æ–°æ•¸æ“šè®€å– -->
<div class="card realtime-data-container">
    <h2>ğŸ“¡ æœ€æ–°æ•¸æ“šè®€å–</h2>
    <div class="data-row">
        <div class="data-item temperature">
            <label>æº«åº¦</label>
            <span class="value" id="latest-temperature">{{ readings.0.temperature|default:"--" }} Â°C</span>
        </div>
        <div class="data-item ph">
            <label>é…¸é¹¼å€¼</label>
            <span class="value" id="latest-ph">{{ readings.0.ph|default:"--" }}</span>
        </div>
        <div class="data-item oxygen">
            <label>æº¶æ°§</label>
            <span class="value" id="latest-oxygen">{{ readings.0.oxygen|default:"--" }} mg/L</span>
        </div>
        <div class="data-item salinity">
            <label>é¹½åº¦</label>
            <span class="value" id="latest-salinity">{{ readings.0.salinity|default:"--" }} psu</span>
        </div>
        <div class="data-item conductivity">
            <label>é›»å°ç‡</label>
            <span class="value" id="latest-conductivity">{{ readings.0.conductivity|default:"--" }} ÂµS/cm</span>
        </div>
        <div class="data-item pressure">
            <label>å£“åŠ›</label>
            <span class="value" id="latest-pressure">{{ readings.0.pressure|default:"--" }} bar</span>
        </div>
        <div class="data-item fluorescence">
            <label>è¢å…‰å€¼</label>
            <span class="value" id="latest-fluorescence">{{ readings.0.fluorescence|default:"--" }}</span>
        </div>
        <div class="data-item turbidity">
            <label>æ¿åº¦</label>
            <span class="value" id="latest-turbidity">{{ readings.0.turbidity|default:"--" }}</span>
        </div>
    </div>
    <p style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
        æœ€å¾Œæ›´æ–°: <span id="latest-timestamp">{{ readings.0.timestamp|date:"Y-m-d H:i:s"|default:"--" }}</span>
    </p>
</div>

<!-- æ•¸æ“šçµ±è¨ˆå¡ç‰‡ -->
<div class="card stats-card">
    <h2>ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h2>
    <h3>æº«åº¦ (Â°C)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-temperature-min">{{ stats.temperature.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-temperature-avg">{{ stats.temperature.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-temperature-max">{{ stats.temperature.max|default:"--" }}</div>
        </div>
    </div>

    <h3>é…¸é¹¼å€¼ (pH)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-ph-min">{{ stats.ph.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-ph-avg">{{ stats.ph.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-ph-max">{{ stats.ph.max|default:"--" }}</div>
        </div>
    </div>

    <h3>æº¶æ°§ (mg/L)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-oxygen-min">{{ stats.oxygen.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-oxygen-avg">{{ stats.oxygen.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-oxygen-max">{{ stats.oxygen.max|default:"--" }}</div>
        </div>
    </div>

    <h3>é¹½åº¦ (PSU)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-salinity-min">{{ stats.salinity.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-salinity-avg">{{ stats.salinity.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-salinity-max">{{ stats.salinity.max|default:"--" }}</div>
        </div>
    </div>
</div>

<!-- æ•¸æ“šè¶¨å‹¢åœ– -->
<div class="card">
    <h2>ğŸ“ˆ æ•¸æ“šè¶¨å‹¢åœ–</h2>
    <canvas id="dataChart" data-chart-json="{{ chart_data_json|safe }}"></canvas>
</div>

<!-- æ•¸æ“šè¡¨æ ¼ -->
<div class="card">
    <h2>ğŸ“‹ æœ€æ–°æ•¸æ“šè¨˜éŒ„ï¼ˆæœ€æ–° 50 ç­†ï¼‰</h2>

    <!-- æ•¸æ“šè¡¨æ ¼å®¹å™¨ -->
    <div style="position: relative; overflow: hidden;">
        <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
        <button id="scrollLeft" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0 4px 4px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">
            â—€
        </button>
        <button id="scrollRight" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 4px 0 0 4px; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            â–¶
        </button>

        <!-- å¯æ»¾å‹•çš„è¡¨æ ¼ -->
        <div id="tableContainer" style="overflow-x: auto; scroll-behavior: smooth; padding: 0 2.5rem;">
            <table style="min-width: 1200px;">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;">æ™‚é–“</th>
                        <th style="white-space: nowrap;">æº«åº¦ (Â°C)</th>
                        <th style="white-space: nowrap;">é…¸é¹¼å€¼</th>
                        <th style="white-space: nowrap;">æº¶æ°§ (mg/L)</th>
                        <th style="white-space: nowrap;">é¹½åº¦ (PSU)</th>
                        <th style="white-space: nowrap;">é›»å°ç‡ (mS/cm)</th>
                        <th style="white-space: nowrap;">å£“åŠ› (dbar)</th>
                        <th style="white-space: nowrap;">è¢å…‰å€¼ (Âµg/L)</th>
                        <th style="white-space: nowrap;">æ¿åº¦ (NTU)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reading in readings %}
                    <tr>
                        <td style="white-space: nowrap;">{{ reading.timestamp }}</td>
                        <td style="white-space: nowrap;">{{ reading.temperature|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.ph|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.oxygen|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.salinity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.conductivity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.pressure|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.fluorescence|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.turbidity|floatformat:2|default:"--" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" style="text-align:center; color:#999;">å°šç„¡æ•¸æ“šè¨˜éŒ„</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
        æç¤º: ä½¿ç”¨å·¦å³ç®­é ­æŒ‰éˆ•æˆ–æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ•¸æ“š
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('tableContainer');
    const leftBtn = document.getElementById('scrollLeft');
    const rightBtn = document.getElementById('scrollRight');

    if (container && leftBtn && rightBtn) {
        // å·¦å³æ»¾å‹•åŠŸèƒ½
        leftBtn.addEventListener('click', function() {
            container.scrollLeft -= 300;
        });

        rightBtn.addEventListener('click', function() {
            container.scrollLeft += 300;
        });

        // æ ¹æ“šæ»¾å‹•ä½ç½®é¡¯ç¤º/éš±è—æŒ‰éˆ•
        function updateButtons() {
            if (container.scrollLeft <= 0) {
                leftBtn.style.opacity = '0.3';
                leftBtn.style.cursor = 'default';
            } else {
                leftBtn.style.opacity = '1';
                leftBtn.style.cursor = 'pointer';
            }

            if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 10) {
                rightBtn.style.opacity = '0.3';
                rightBtn.style.cursor = 'default';
            } else {
                rightBtn.style.opacity = '1';
                rightBtn.style.cursor = 'pointer';
            }
        }

        container.addEventListener('scroll', updateButtons);
        updateButtons();

        // æ”¯æŒè§¸æ§æ»‘å‹•
        let isDown = false;
        let startX;
        let scrollLeftStart;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - container.offsetLeft;
            scrollLeftStart = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
            isDown = false;
        });

        container.addEventListener('mouseup', () => {
            isDown = false;
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2;
            container.scrollLeft = scrollLeftStart - walk;
        });
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'realtime/realtime.js' %}"></script>
<script>
var chartData = JSON.parse('{{ chart_data_json|escapejs }}');
var ctx = document.getElementById('dataChart').getContext('2d');
window.chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: [{
            label: 'æº«åº¦ (Â°C)',
            data: chartData.temperature,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            yAxisID: 'y',
        }, {
            label: 'é…¸é¹¼å€¼ (pH)',
            data: chartData.ph,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            yAxisID: 'y1',
        }, {
            label: 'æº¶æ°§ (mg/L)',
            data: chartData.oxygen,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            yAxisID: 'y',
        }, {
            label: 'é¹½åº¦ (PSU)',
            data: chartData.salinity,
            borderColor: 'rgb(153, 102, 255)',
            backgroundColor: 'rgba(153, 102, 255, 0.1)',
            yAxisID: 'y2',
        }]
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: 'æº«åº¦ / æº¶æ°§' }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'é…¸é¹¼å€¼' },
                grid: { drawOnChartArea: false }
            },
            y2: {
                type: 'linear',
                display: false
            }
        }
    }
});

// åˆå§‹åŒ– realtime ç›£æ§æ™‚ï¼ŒæŠŠåœ–è¡¨å¯¦ä¾‹å‚³çµ¦å®ƒ
if (window.realtimeInit) {
    window.realtimeInit();
}
</script>
{% endblock %}