{% extends 'base.html' %}
{% load static %}

{% block title %}{{ station.station_name }} - Ocean Monitor Web{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'realtime/realtime.css' %}">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
/* 專業站點詳情樣式 */
.station-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.info-card {
    background: var(--bg-primary);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.info-card p {
    margin: 0.75rem 0;
    color: var(--text-primary);
    font-size: 0.95rem;
}

.info-card strong {
    color: var(--text-secondary);
    font-weight: 600;
    margin-right: 0.5rem;
}

/* 時間範圍按鈕樣式 */
.time-range-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin: 1.5rem 0;
}

.time-range-btn {
    padding: 0.6rem 1.2rem;
    border: 2px solid var(--border-color);
    background-color: white;
    color: var(--text-primary);
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
}

.time-range-btn:hover {
    background-color: var(--bg-primary);
    border-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.time-range-btn.active {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(12, 74, 110, 0.3);
}

/* 參數選擇器樣式 */
.parameter-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin: 1.5rem 0;
}

.parameter-selector label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1rem;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
    font-size: 0.9rem;
}

.parameter-selector label:hover {
    border-color: var(--secondary-color);
    background: var(--bg-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.param-checkbox {
    cursor: pointer;
    width: 18px;
    height: 18px;
    accent-color: var(--secondary-color);
}

.param-checkbox:checked + span {
    font-weight: 700;
    color: var(--primary-color);
}

label:has(.param-checkbox:checked) {
    border-color: var(--secondary-color);
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

/* 實時數據樣式 */
.realtime-data-container .data-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.data-item {
    background: linear-gradient(135deg, var(--bg-primary) 0%, white 100%);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    text-align: center;
    transition: all 0.3s;
}

.data-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--secondary-color);
}

.data-item label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.data-item .value {
    display: block;
    color: var(--primary-color);
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 0.5rem;
}
</style>

<div class="card">
    <h2>{{ station.station_name }}</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
            <p><strong>設備型號：</strong>{{ station.device_model }}</p>
            <p><strong>裝設地點：</strong>{{ station.location }}</p>
            <p><strong>裝設日期：</strong>{{ station.install_date }}</p>
            <p><strong>數據筆數：</strong><span id="total-reading-count">{{ total_count }}</span> 筆</p>
            {% if station.latitude and station.longitude %}
            <p><strong>座標位置：</strong>{{ station.latitude }}, {{ station.longitude }}</p>
            {% endif %}
        </div>
        {% if station.latitude and station.longitude %}
        <div>
            <div id="stationMap" style="height: 250px; border-radius: 8px; border: 2px solid #dee2e6;"></div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 實時數據容器 - JavaScript 會在此插入狀態指示器 -->
<div id="realtime-container" data-station-id="{{ station.id }}"></div>

<!-- 最新數據讀取 -->
<div class="card realtime-data-container">
    <h2>最新數據讀取</h2>
    <div class="data-row">
        <div class="data-item temperature">
            <label>溫度</label>
            <span class="value" id="latest-temperature">{{ readings.0.temperature|default:"--" }} °C</span>
        </div>
        <div class="data-item ph">
            <label>酸鹼值</label>
            <span class="value" id="latest-ph">{{ readings.0.ph|default:"--" }}</span>
        </div>
        <div class="data-item oxygen">
            <label>溶氧</label>
            <span class="value" id="latest-oxygen">{{ readings.0.oxygen|default:"--" }} mg/L</span>
        </div>
        <div class="data-item salinity">
            <label>鹽度</label>
            <span class="value" id="latest-salinity">{{ readings.0.salinity|default:"--" }} psu</span>
        </div>
        <div class="data-item conductivity">
            <label>電導率</label>
            <span class="value" id="latest-conductivity">{{ readings.0.conductivity|default:"--" }} µS/cm</span>
        </div>
        <div class="data-item pressure">
            <label>壓力</label>
            <span class="value" id="latest-pressure">{{ readings.0.pressure|default:"--" }} bar</span>
        </div>
        <div class="data-item fluorescence">
            <label>螢光值</label>
            <span class="value" id="latest-fluorescence">{{ readings.0.fluorescence|default:"--" }}</span>
        </div>
        <div class="data-item turbidity">
            <label>濁度</label>
            <span class="value" id="latest-turbidity">{{ readings.0.turbidity|default:"--" }}</span>
        </div>
    </div>
    <p style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
        最後更新: <span id="latest-timestamp">{{ readings.0.timestamp|date:"Y-m-d H:i:s"|default:"--" }}</span>
    </p>
</div>

<!-- 數據統計卡片 -->
<div class="card stats-card">
    <h2>數據統計</h2>
    <h3>溫度 (°C)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">最小值</div>
            <div class="value" id="stat-temperature-min">{{ stats.temperature.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">平均值</div>
            <div class="value" id="stat-temperature-avg">{{ stats.temperature.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">最大值</div>
            <div class="value" id="stat-temperature-max">{{ stats.temperature.max|default:"--" }}</div>
        </div>
    </div>

    <h3>酸鹼值 (pH)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">最小值</div>
            <div class="value" id="stat-ph-min">{{ stats.ph.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">平均值</div>
            <div class="value" id="stat-ph-avg">{{ stats.ph.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">最大值</div>
            <div class="value" id="stat-ph-max">{{ stats.ph.max|default:"--" }}</div>
        </div>
    </div>

    <h3>溶氧 (mg/L)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">最小值</div>
            <div class="value" id="stat-oxygen-min">{{ stats.oxygen.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">平均值</div>
            <div class="value" id="stat-oxygen-avg">{{ stats.oxygen.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">最大值</div>
            <div class="value" id="stat-oxygen-max">{{ stats.oxygen.max|default:"--" }}</div>
        </div>
    </div>

    <h3>鹽度 (PSU)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">最小值</div>
            <div class="value" id="stat-salinity-min">{{ stats.salinity.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">平均值</div>
            <div class="value" id="stat-salinity-avg">{{ stats.salinity.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">最大值</div>
            <div class="value" id="stat-salinity-max">{{ stats.salinity.max|default:"--" }}</div>
        </div>
    </div>
</div>

<!-- 數據趨勢圖 -->
<div class="card">
    <h2>數據趨勢圖</h2>

    <!-- 時間範圍選擇器 -->
    <div style="margin-bottom: 15px; padding: 15px; background-color: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
        <h3 style="font-size: 16px; margin-bottom: 12px; color: #495057;">選擇時間範圍:</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button class="time-range-btn {% if time_range == '1h' %}active{% endif %}" data-range="1h" onclick="changeTimeRange('1h')">最近 1 小時</button>
            <button class="time-range-btn {% if time_range == '6h' %}active{% endif %}" data-range="6h" onclick="changeTimeRange('6h')">最近 6 小時</button>
            <button class="time-range-btn {% if time_range == '12h' %}active{% endif %}" data-range="12h" onclick="changeTimeRange('12h')">最近 12 小時</button>
            <button class="time-range-btn {% if time_range == '24h' or not time_range %}active{% endif %}" data-range="24h" onclick="changeTimeRange('24h')">最近 24 小時</button>
            <button class="time-range-btn {% if time_range == '3d' %}active{% endif %}" data-range="3d" onclick="changeTimeRange('3d')">最近 3 天</button>
            <button class="time-range-btn {% if time_range == '7d' %}active{% endif %}" data-range="7d" onclick="changeTimeRange('7d')">最近 7 天</button>
            <button class="time-range-btn {% if time_range == '30d' %}active{% endif %}" data-range="30d" onclick="changeTimeRange('30d')">最近 30 天</button>
            <button class="time-range-btn {% if time_range == 'all' %}active{% endif %}" data-range="all" onclick="changeTimeRange('all')">全部數據</button>
        </div>
    </div>

    <!-- 參數選擇器 -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
        <h3 style="font-size: 16px; margin-bottom: 12px; color: #495057;">選擇顯示參數:</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="temperature" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #dc3545;">溫度 (°C)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="ph" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #0d6efd;">酸鹼值 (pH)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="oxygen" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #198754;">溶氧 (mg/L)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="salinity" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #6f42c1;">鹽度 (PSU)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="conductivity" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #fd7e14;">電導率 (mS/cm)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="pressure" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #20c997;">壓力 (dbar)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="fluorescence" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #d63384;">螢光值 (µg/L)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="turbidity" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #6c757d;">濁度 (NTU)</span>
            </label>
        </div>
    </div>

    <canvas id="dataChart" data-chart-json="{{ chart_data_json|safe }}"></canvas>
</div>

<!-- 儀器移動軌跡地圖 -->
{% if gps_points %}
<div class="card">
    <h2>儀器移動軌跡（最新 100 個 GPS 點）</h2>
    <div style="width: 100%; max-width: 100%; overflow: hidden; margin-bottom: 1rem;">
        <div id="trajectory-map" style="height: 600px; width: 100%; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
    </div>
</div>
{% else %}
<div class="card">
    <h2>儀器移動軌跡</h2>
    <div style="background: #f8f9fa; padding: 2rem; text-align: center; border-radius: 8px;">
        <p style="color: #6c757d; margin: 0;">
            尚無 GPS 軌跡數據。請先為測站設定經緯度並生成數據記錄。
        </p>
    </div>
</div>
{% endif %}

<!-- 完整數據記錄表格（最新 100 筆）-->
<div class="card">
    <h2>完整數據記錄（最新 100 筆）</h2>

    <!-- 數據表格容器 -->
    <div style="position: relative; overflow: hidden;">
        <!-- 左右切換按鈕 -->
        <button id="scrollLeft2" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0 4px 4px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">
            ◀
        </button>
        <button id="scrollRight2" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 4px 0 0 4px; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            ▶
        </button>

        <!-- 可滾動的表格 -->
        <div id="tableContainer2" style="overflow-x: auto; scroll-behavior: smooth; padding: 0 2.5rem;">
            <table style="min-width: 1400px;">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;">時間</th>
                        <th style="white-space: nowrap;">溫度 (°C)</th>
                        <th style="white-space: nowrap;">酸鹼值</th>
                        <th style="white-space: nowrap;">溶氧 (mg/L)</th>
                        <th style="white-space: nowrap;">鹽度 (PSU)</th>
                        <th style="white-space: nowrap;">電導率 (mS/cm)</th>
                        <th style="white-space: nowrap;">壓力 (dbar)</th>
                        <th style="white-space: nowrap;">螢光值 (µg/L)</th>
                        <th style="white-space: nowrap;">濁度 (NTU)</th>
                    </tr>
                </thead>
                <tbody id="latest-readings-tbody">
                    {% for reading in latest_readings %}
                    <tr>
                        <td style="white-space: nowrap;">{{ reading.timestamp }}</td>
                        <td style="white-space: nowrap;">{{ reading.temperature|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.ph|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.oxygen|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.salinity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.conductivity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.pressure|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.fluorescence|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.turbidity|floatformat:2|default:"--" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" style="text-align:center; color:#999;">尚無數據記錄</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
        提示: 使用左右箭頭按鈕或滑動查看完整數據
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 完整數據記錄表格的滾動功能
    const container2 = document.getElementById('tableContainer2');
    const leftBtn2 = document.getElementById('scrollLeft2');
    const rightBtn2 = document.getElementById('scrollRight2');

    if (container2 && leftBtn2 && rightBtn2) {
        leftBtn2.addEventListener('click', function() {
            container2.scrollLeft -= 300;
        });

        rightBtn2.addEventListener('click', function() {
            container2.scrollLeft += 300;
        });

        function updateButtons2() {
            if (container2.scrollLeft <= 0) {
                leftBtn2.style.opacity = '0.3';
                leftBtn2.style.cursor = 'default';
            } else {
                leftBtn2.style.opacity = '1';
                leftBtn2.style.cursor = 'pointer';
            }

            if (container2.scrollLeft >= container2.scrollWidth - container2.clientWidth - 10) {
                rightBtn2.style.opacity = '0.3';
                rightBtn2.style.cursor = 'default';
            } else {
                rightBtn2.style.opacity = '1';
                rightBtn2.style.cursor = 'pointer';
            }
        }

        container2.addEventListener('scroll', updateButtons2);
        updateButtons2();

        let isDown2 = false;
        let startX2;
        let scrollLeftStart2;

        container2.addEventListener('mousedown', (e) => {
            isDown2 = true;
            startX2 = e.pageX - container2.offsetLeft;
            scrollLeftStart2 = container2.scrollLeft;
        });

        container2.addEventListener('mouseleave', () => {
            isDown2 = false;
        });

        container2.addEventListener('mouseup', () => {
            isDown2 = false;
        });

        container2.addEventListener('mousemove', (e) => {
            if (!isDown2) return;
            e.preventDefault();
            const x = e.pageX - container2.offsetLeft;
            const walk = (x - startX2) * 2;
            container2.scrollLeft = scrollLeftStart2 - walk;
        });
    }

    // 定期刷新最新數據記錄表格（每 30 秒）
    function refreshLatestReadings() {
        const stationId = '{{ station.id }}';
        const tbody = document.getElementById('latest-readings-tbody');

        if (!tbody) return;

        fetch('/stations/' + stationId + '/')
            .then(response => response.text())
            .then(html => {
                // 解析返回的 HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTbody = doc.getElementById('latest-readings-tbody');

                if (newTbody) {
                    // 更新表格內容
                    tbody.innerHTML = newTbody.innerHTML;
                    console.log('[刷新] 最新數據記錄已更新');
                }
            })
            .catch(error => {
                console.error('[刷新] 更新失敗:', error);
            });
    }

    // 每 30 秒自動刷新一次
    setInterval(refreshLatestReadings, 30000);
    console.log('[刷新] 定期刷新已啟動（每 30 秒）');
});

// GPS 軌跡地圖初始化 (Leaflet)
{% if gps_points %}
document.addEventListener('DOMContentLoaded', function() {
    const gpsPoints = {{ gps_points_json|safe }};

    if (!gpsPoints || gpsPoints.length === 0) {
        console.warn('沒有 GPS 數據點');
        return;
    }

    console.log(`載入 ${gpsPoints.length} 個 GPS 數據點`);

    // 計算地圖中心點
    const lats = gpsPoints.map(p => p.latitude);
    const lngs = gpsPoints.map(p => p.longitude);
    const avgLat = lats.reduce((a, b) => a + b, 0) / lats.length;
    const avgLng = lngs.reduce((a, b) => a + b, 0) / lngs.length;

    // 初始化 Leaflet 地圖
    const map = L.map('trajectory-map').setView([avgLat, avgLng], 14);

    // 添加 OpenStreetMap 圖層
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // 創建軌跡線
    const lineCoordinates = gpsPoints.map(p => [p.latitude, p.longitude]);
    const polyline = L.polyline(lineCoordinates, {
        color: '#667eea',
        weight: 4,
        opacity: 0.8
    }).addTo(map);

    // 添加起點和終點標記
    if (gpsPoints.length > 0) {
        const firstPoint = gpsPoints[0];
        const lastPoint = gpsPoints[gpsPoints.length - 1];

        // 起點標記（綠色）
        L.circleMarker([firstPoint.latitude, firstPoint.longitude], {
            radius: 8,
            fillColor: '#28a745',
            color: '#fff',
            weight: 2,
            fillOpacity: 0.9
        }).bindPopup(`
            <div style="min-width: 200px;">
                <div style="color: #28a745; font-weight: 600; margin-bottom: 5px;">起點</div>
                <strong>{{ station.station_name }}</strong><br>
                <small>${new Date(firstPoint.timestamp).toLocaleString('zh-TW')}</small>
                <hr style="margin: 8px 0;">
                ${firstPoint.temperature !== null ? `溫度: ${firstPoint.temperature.toFixed(2)}°C<br>` : ''}
                ${firstPoint.ph !== null ? `pH: ${firstPoint.ph.toFixed(2)}<br>` : ''}
                ${firstPoint.oxygen !== null ? `溶氧: ${firstPoint.oxygen.toFixed(2)} mg/L<br>` : ''}
                <small>${firstPoint.latitude.toFixed(6)}, ${firstPoint.longitude.toFixed(6)}</small>
            </div>
        `).addTo(map);

        // 終點標記（紅色）
        L.circleMarker([lastPoint.latitude, lastPoint.longitude], {
            radius: 10,
            fillColor: '#dc3545',
            color: '#fff',
            weight: 2,
            fillOpacity: 0.9
        }).bindPopup(`
            <div style="min-width: 200px;">
                <div style="color: #dc3545; font-weight: 600; margin-bottom: 5px;">最新位置</div>
                <strong>{{ station.station_name }}</strong><br>
                <small>${new Date(lastPoint.timestamp).toLocaleString('zh-TW')}</small>
                <hr style="margin: 8px 0;">
                ${lastPoint.temperature !== null ? `溫度: ${lastPoint.temperature.toFixed(2)}°C<br>` : ''}
                ${lastPoint.ph !== null ? `pH: ${lastPoint.ph.toFixed(2)}<br>` : ''}
                ${lastPoint.oxygen !== null ? `溶氧: ${lastPoint.oxygen.toFixed(2)} mg/L<br>` : ''}
                <small>${lastPoint.latitude.toFixed(6)}, ${lastPoint.longitude.toFixed(6)}</small>
            </div>
        `).addTo(map);
    }

    // 自動調整視圖以顯示所有點
    const bounds = L.latLngBounds(gpsPoints.map(p => [p.latitude, p.longitude]));
    map.fitBounds(bounds, { padding: [50, 50] });

    console.log('GPS 軌跡地圖初始化完成');
});
{% endif %}
</script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{% if station.latitude and station.longitude %}
<script>
// 初始化地圖
document.addEventListener('DOMContentLoaded', function() {
    const lat = parseFloat('{{ station.latitude }}');
    const lng = parseFloat('{{ station.longitude }}');

    if (lat && lng) {
        // 創建地圖
        const map = L.map('stationMap').setView([lat, lng], 13);

        // 添加 OpenStreetMap 圖層
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // 添加標記
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup('<b>{{ station.station_name }}</b><br>{{ station.location }}').openPopup();
    }
});
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'realtime/realtime.js' %}"></script>
<script>
// 完整的參數配置
const parameterConfig = {
    temperature: {
        label: '溫度 (°C)',
        borderColor: 'rgb(220, 53, 69)',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
    },
    ph: {
        label: '酸鹼值 (pH)',
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
    },
    oxygen: {
        label: '溶氧 (mg/L)',
        borderColor: 'rgb(25, 135, 84)',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
    },
    salinity: {
        label: '鹽度 (PSU)',
        borderColor: 'rgb(111, 66, 193)',
        backgroundColor: 'rgba(111, 66, 193, 0.1)',
    },
    conductivity: {
        label: '電導率 (mS/cm)',
        borderColor: 'rgb(253, 126, 20)',
        backgroundColor: 'rgba(253, 126, 20, 0.1)',
    },
    pressure: {
        label: '壓力 (dbar)',
        borderColor: 'rgb(32, 201, 151)',
        backgroundColor: 'rgba(32, 201, 151, 0.1)',
    },
    fluorescence: {
        label: '螢光值 (µg/L)',
        borderColor: 'rgb(214, 51, 132)',
        backgroundColor: 'rgba(214, 51, 132, 0.1)',
    },
    turbidity: {
        label: '濁度 (NTU)',
        borderColor: 'rgb(108, 117, 125)',
        backgroundColor: 'rgba(108, 117, 125, 0.1)',
    }
};

var chartData = JSON.parse('{{ chart_data_json|escapejs }}');
var ctx = document.getElementById('dataChart').getContext('2d');
var currentTimeRange = '{{ time_range }}' || '24h'; // 追蹤當前時間範圍

// 根據時間範圍獲取 x 軸配置
function getXAxisConfig(timeRange) {
    const configs = {
        '1h': {
            title: '時間（最近 1 小時）',
            ticks: { maxTicksLimit: 12 }
        },
        '6h': {
            title: '時間（最近 6 小時）',
            ticks: { maxTicksLimit: 12 }
        },
        '12h': {
            title: '時間（最近 12 小時）',
            ticks: { maxTicksLimit: 12 }
        },
        '24h': {
            title: '時間（最近 24 小時）',
            ticks: { maxTicksLimit: 12 }
        },
        '3d': {
            title: '時間（最近 3 天）',
            ticks: { maxTicksLimit: 15 }
        },
        '7d': {
            title: '時間（最近 7 天）',
            ticks: { maxTicksLimit: 14 }
        },
        '30d': {
            title: '時間（最近 30 天）',
            ticks: { maxTicksLimit: 15 }
        },
        'all': {
            title: '時間（全部數據）',
            ticks: { maxTicksLimit: 20 }
        }
    };

    return configs[timeRange] || configs['24h'];
}

// 創建圖表實例
window.chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: []
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                display: true,
                position: 'top',
            },
            tooltip: {
                mode: 'index',
                intersect: false,
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: getXAxisConfig(currentTimeRange).title
                },
                ticks: getXAxisConfig(currentTimeRange).ticks
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
            }
        }
    }
});

// 更新圖表的函數
function updateChart() {
    const checkboxes = document.querySelectorAll('.param-checkbox:checked');
    const datasets = [];

    checkboxes.forEach(checkbox => {
        const param = checkbox.dataset.param;
        const config = parameterConfig[param];

        if (config && chartData[param]) {
            datasets.push({
                label: config.label,
                data: chartData[param],
                borderColor: config.borderColor,
                backgroundColor: config.backgroundColor,
                tension: 0.1,
                borderWidth: 2,
            });
        }
    });

    // 更新數據集
    window.chartInstance.data.datasets = datasets;

    // 更新 labels（時間標籤）
    window.chartInstance.data.labels = chartData.labels;

    // 更新 x 軸配置
    const xAxisConfig = getXAxisConfig(currentTimeRange);
    window.chartInstance.options.scales.x.title.text = xAxisConfig.title;
    window.chartInstance.options.scales.x.ticks = xAxisConfig.ticks;

    window.chartInstance.update();
}

// 監聽 checkbox 變化
document.querySelectorAll('.param-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateChart);

    // 添加視覺效果
    checkbox.parentElement.addEventListener('click', function(e) {
        if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            updateChart();
        }
    });
});

// 初始化圖表 - 顯示默認選中的參數
updateChart();

// 時間範圍切換函數 - 使用 AJAX 不重新載入頁面
function changeTimeRange(range) {
    // 更新當前時間範圍
    currentTimeRange = range;

    // 更新按鈕狀態
    document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // 顯示載入中狀態
    const canvas = document.getElementById('dataChart');
    canvas.style.opacity = '0.5';

    // 使用 AJAX 獲取新數據
    const stationId = '{{ station.id }}';
    fetch('/stations/' + stationId + '/chart-data/?time_range=' + range)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 更新全局 chartData
                chartData = data.chart_data;

                // 更新圖表（會自動使用新的 currentTimeRange 更新 x 軸配置）
                updateChart();

                // 恢復透明度
                canvas.style.opacity = '1';
            }
        })
        .catch(error => {
            console.error('Error fetching chart data:', error);
            canvas.style.opacity = '1';
            alert('載入圖表數據失敗,請重試');
        });
}

// 初始化 realtime 監控時，把圖表實例傳給它
if (window.realtimeInit) {
    window.realtimeInit();
}
</script>
{% endblock %}