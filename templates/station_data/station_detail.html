{% extends 'base.html' %}
{% load static %}

{% block title %}{{ station.station_name }} - æµ·æ´‹ç›£æ¸¬ç³»çµ±{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'realtime/realtime.css' %}">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
/* æ™‚é–“ç¯„åœæŒ‰éˆ•æ¨£å¼ */
.time-range-btn {
    padding: 10px 16px;
    border: 2px solid #ffc107;
    background-color: white;
    color: #333;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}

.time-range-btn:hover {
    background-color: #fff8e1;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.time-range-btn.active {
    background-color: #ffc107;
    color: white;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

/* åƒæ•¸é¸æ“‡å™¨æ¨£å¼ */
.param-checkbox:checked + span {
    font-weight: 700;
}

.param-checkbox:checked ~ * {
    background-color: #e7f3ff;
}

label:has(.param-checkbox:checked) {
    border-color: #0d6efd !important;
    background-color: #e7f3ff !important;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
}

label:hover {
    border-color: #0d6efd !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
</style>

<div class="card">
    <h2>ğŸŒŠ {{ station.station_name }}</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
            <p><strong>è¨­å‚™å‹è™Ÿï¼š</strong>{{ station.device_model }}</p>
            <p><strong>è£è¨­åœ°é»ï¼š</strong>{{ station.location }}</p>
            <p><strong>è£è¨­æ—¥æœŸï¼š</strong>{{ station.install_date }}</p>
            <p><strong>æ•¸æ“šç­†æ•¸ï¼š</strong><span id="total-reading-count">{{ total_count }}</span> ç­†</p>
            {% if station.latitude and station.longitude %}
            <p><strong>ğŸ“ åº§æ¨™ä½ç½®ï¼š</strong>{{ station.latitude }}, {{ station.longitude }}</p>
            {% endif %}
        </div>
        {% if station.latitude and station.longitude %}
        <div>
            <div id="stationMap" style="height: 250px; border-radius: 8px; border: 2px solid #dee2e6;"></div>
        </div>
        {% endif %}
    </div>
</div>

<!-- å¯¦æ™‚æ•¸æ“šå®¹å™¨ - JavaScript æœƒåœ¨æ­¤æ’å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div id="realtime-container" data-station-id="{{ station.id }}"></div>

<!-- æœ€æ–°æ•¸æ“šè®€å– -->
<div class="card realtime-data-container">
    <h2>ğŸ“¡ æœ€æ–°æ•¸æ“šè®€å–</h2>
    <div class="data-row">
        <div class="data-item temperature">
            <label>æº«åº¦</label>
            <span class="value" id="latest-temperature">{{ readings.0.temperature|default:"--" }} Â°C</span>
        </div>
        <div class="data-item ph">
            <label>é…¸é¹¼å€¼</label>
            <span class="value" id="latest-ph">{{ readings.0.ph|default:"--" }}</span>
        </div>
        <div class="data-item oxygen">
            <label>æº¶æ°§</label>
            <span class="value" id="latest-oxygen">{{ readings.0.oxygen|default:"--" }} mg/L</span>
        </div>
        <div class="data-item salinity">
            <label>é¹½åº¦</label>
            <span class="value" id="latest-salinity">{{ readings.0.salinity|default:"--" }} psu</span>
        </div>
        <div class="data-item conductivity">
            <label>é›»å°ç‡</label>
            <span class="value" id="latest-conductivity">{{ readings.0.conductivity|default:"--" }} ÂµS/cm</span>
        </div>
        <div class="data-item pressure">
            <label>å£“åŠ›</label>
            <span class="value" id="latest-pressure">{{ readings.0.pressure|default:"--" }} bar</span>
        </div>
        <div class="data-item fluorescence">
            <label>è¢å…‰å€¼</label>
            <span class="value" id="latest-fluorescence">{{ readings.0.fluorescence|default:"--" }}</span>
        </div>
        <div class="data-item turbidity">
            <label>æ¿åº¦</label>
            <span class="value" id="latest-turbidity">{{ readings.0.turbidity|default:"--" }}</span>
        </div>
    </div>
    <p style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
        æœ€å¾Œæ›´æ–°: <span id="latest-timestamp">{{ readings.0.timestamp|date:"Y-m-d H:i:s"|default:"--" }}</span>
    </p>
</div>

<!-- æ•¸æ“šçµ±è¨ˆå¡ç‰‡ -->
<div class="card stats-card">
    <h2>ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h2>
    <h3>æº«åº¦ (Â°C)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-temperature-min">{{ stats.temperature.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-temperature-avg">{{ stats.temperature.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-temperature-max">{{ stats.temperature.max|default:"--" }}</div>
        </div>
    </div>

    <h3>é…¸é¹¼å€¼ (pH)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-ph-min">{{ stats.ph.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-ph-avg">{{ stats.ph.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-ph-max">{{ stats.ph.max|default:"--" }}</div>
        </div>
    </div>

    <h3>æº¶æ°§ (mg/L)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-oxygen-min">{{ stats.oxygen.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-oxygen-avg">{{ stats.oxygen.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-oxygen-max">{{ stats.oxygen.max|default:"--" }}</div>
        </div>
    </div>

    <h3>é¹½åº¦ (PSU)</h3>
    <div class="stat-row">
        <div class="stat-value">
            <div class="label">æœ€å°å€¼</div>
            <div class="value" id="stat-salinity-min">{{ stats.salinity.min|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">å¹³å‡å€¼</div>
            <div class="value" id="stat-salinity-avg">{{ stats.salinity.avg|default:"--" }}</div>
        </div>
        <div class="stat-value">
            <div class="label">æœ€å¤§å€¼</div>
            <div class="value" id="stat-salinity-max">{{ stats.salinity.max|default:"--" }}</div>
        </div>
    </div>
</div>

<!-- æ•¸æ“šè¶¨å‹¢åœ– -->
<div class="card">
    <h2>ğŸ“ˆ æ•¸æ“šè¶¨å‹¢åœ–</h2>

    <!-- æ™‚é–“ç¯„åœé¸æ“‡å™¨ -->
    <div style="margin-bottom: 15px; padding: 15px; background-color: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
        <h3 style="font-size: 16px; margin-bottom: 12px; color: #495057;">â±ï¸ é¸æ“‡æ™‚é–“ç¯„åœ:</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button class="time-range-btn {% if time_range == '1h' %}active{% endif %}" data-range="1h" onclick="changeTimeRange('1h')">æœ€è¿‘ 1 å°æ™‚</button>
            <button class="time-range-btn {% if time_range == '6h' %}active{% endif %}" data-range="6h" onclick="changeTimeRange('6h')">æœ€è¿‘ 6 å°æ™‚</button>
            <button class="time-range-btn {% if time_range == '12h' %}active{% endif %}" data-range="12h" onclick="changeTimeRange('12h')">æœ€è¿‘ 12 å°æ™‚</button>
            <button class="time-range-btn {% if time_range == '24h' or not time_range %}active{% endif %}" data-range="24h" onclick="changeTimeRange('24h')">æœ€è¿‘ 24 å°æ™‚</button>
            <button class="time-range-btn {% if time_range == '3d' %}active{% endif %}" data-range="3d" onclick="changeTimeRange('3d')">æœ€è¿‘ 3 å¤©</button>
            <button class="time-range-btn {% if time_range == '7d' %}active{% endif %}" data-range="7d" onclick="changeTimeRange('7d')">æœ€è¿‘ 7 å¤©</button>
            <button class="time-range-btn {% if time_range == '30d' %}active{% endif %}" data-range="30d" onclick="changeTimeRange('30d')">æœ€è¿‘ 30 å¤©</button>
            <button class="time-range-btn {% if time_range == 'all' %}active{% endif %}" data-range="all" onclick="changeTimeRange('all')">å…¨éƒ¨æ•¸æ“š</button>
        </div>
    </div>

    <!-- åƒæ•¸é¸æ“‡å™¨ -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
        <h3 style="font-size: 16px; margin-bottom: 12px; color: #495057;">ğŸ“Š é¸æ“‡é¡¯ç¤ºåƒæ•¸:</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="temperature" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #dc3545;">ğŸŒ¡ï¸ æº«åº¦ (Â°C)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="ph" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #0d6efd;">âš—ï¸ é…¸é¹¼å€¼ (pH)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="oxygen" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #198754;">ğŸ’¨ æº¶æ°§ (mg/L)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="salinity" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #6f42c1;">ğŸ§‚ é¹½åº¦ (PSU)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="conductivity" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #fd7e14;">âš¡ é›»å°ç‡ (mS/cm)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="pressure" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #20c997;">ğŸ“Š å£“åŠ› (dbar)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="fluorescence" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #d63384;">ğŸŒŸ è¢å…‰å€¼ (Âµg/L)</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; border: 2px solid #dee2e6; transition: all 0.2s;">
                <input type="checkbox" class="param-checkbox" data-param="turbidity" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 500; color: #6c757d;">â˜ï¸ æ¿åº¦ (NTU)</span>
            </label>
        </div>
    </div>

    <canvas id="dataChart" data-chart-json="{{ chart_data_json|safe }}"></canvas>
</div>

<!-- å„€å™¨ç§»å‹•è»Œè·¡åœ°åœ– -->
{% if gps_points %}
<div class="card">
    <h2>ğŸ—ºï¸ å„€å™¨ç§»å‹•è»Œè·¡ï¼ˆæœ€æ–° 100 å€‹ GPS é»ï¼‰</h2>
    <div style="width: 100%; max-width: 100%; overflow: hidden; margin-bottom: 1rem;">
        <div id="trajectory-map" style="height: 600px; width: 100%; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
    </div>
</div>
{% else %}
<div class="card">
    <h2>ğŸ—ºï¸ å„€å™¨ç§»å‹•è»Œè·¡</h2>
    <div style="background: #f8f9fa; padding: 2rem; text-align: center; border-radius: 8px;">
        <p style="color: #6c757d; margin: 0;">
            ğŸ“ å°šç„¡ GPS è»Œè·¡æ•¸æ“šã€‚è«‹å…ˆç‚ºæ¸¬ç«™è¨­å®šç¶“ç·¯åº¦ä¸¦ç”Ÿæˆæ•¸æ“šè¨˜éŒ„ã€‚
        </p>
    </div>
</div>
{% endif %}

<!-- å®Œæ•´æ•¸æ“šè¨˜éŒ„è¡¨æ ¼ï¼ˆæœ€æ–° 100 ç­†ï¼‰-->
<div class="card">
    <h2>ğŸ“Š å®Œæ•´æ•¸æ“šè¨˜éŒ„ï¼ˆæœ€æ–° 100 ç­†ï¼‰</h2>

    <!-- æ•¸æ“šè¡¨æ ¼å®¹å™¨ -->
    <div style="position: relative; overflow: hidden;">
        <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
        <button id="scrollLeft2" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0 4px 4px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">
            â—€
        </button>
        <button id="scrollRight2" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 4px 0 0 4px; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            â–¶
        </button>

        <!-- å¯æ»¾å‹•çš„è¡¨æ ¼ -->
        <div id="tableContainer2" style="overflow-x: auto; scroll-behavior: smooth; padding: 0 2.5rem;">
            <table style="min-width: 1400px;">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;">æ™‚é–“</th>
                        <th style="white-space: nowrap;">æº«åº¦ (Â°C)</th>
                        <th style="white-space: nowrap;">é…¸é¹¼å€¼</th>
                        <th style="white-space: nowrap;">æº¶æ°§ (mg/L)</th>
                        <th style="white-space: nowrap;">é¹½åº¦ (PSU)</th>
                        <th style="white-space: nowrap;">é›»å°ç‡ (mS/cm)</th>
                        <th style="white-space: nowrap;">å£“åŠ› (dbar)</th>
                        <th style="white-space: nowrap;">è¢å…‰å€¼ (Âµg/L)</th>
                        <th style="white-space: nowrap;">æ¿åº¦ (NTU)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reading in latest_readings %}
                    <tr>
                        <td style="white-space: nowrap;">{{ reading.timestamp }}</td>
                        <td style="white-space: nowrap;">{{ reading.temperature|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.ph|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.oxygen|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.salinity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.conductivity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.pressure|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.fluorescence|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.turbidity|floatformat:2|default:"--" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" style="text-align:center; color:#999;">å°šç„¡æ•¸æ“šè¨˜éŒ„</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
        æç¤º: ä½¿ç”¨å·¦å³ç®­é ­æŒ‰éˆ•æˆ–æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ•¸æ“š
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // å®Œæ•´æ•¸æ“šè¨˜éŒ„è¡¨æ ¼çš„æ»¾å‹•åŠŸèƒ½
    const container2 = document.getElementById('tableContainer2');
    const leftBtn2 = document.getElementById('scrollLeft2');
    const rightBtn2 = document.getElementById('scrollRight2');

    if (container2 && leftBtn2 && rightBtn2) {
        leftBtn2.addEventListener('click', function() {
            container2.scrollLeft -= 300;
        });

        rightBtn2.addEventListener('click', function() {
            container2.scrollLeft += 300;
        });

        function updateButtons2() {
            if (container2.scrollLeft <= 0) {
                leftBtn2.style.opacity = '0.3';
                leftBtn2.style.cursor = 'default';
            } else {
                leftBtn2.style.opacity = '1';
                leftBtn2.style.cursor = 'pointer';
            }

            if (container2.scrollLeft >= container2.scrollWidth - container2.clientWidth - 10) {
                rightBtn2.style.opacity = '0.3';
                rightBtn2.style.cursor = 'default';
            } else {
                rightBtn2.style.opacity = '1';
                rightBtn2.style.cursor = 'pointer';
            }
        }

        container2.addEventListener('scroll', updateButtons2);
        updateButtons2();

        let isDown2 = false;
        let startX2;
        let scrollLeftStart2;

        container2.addEventListener('mousedown', (e) => {
            isDown2 = true;
            startX2 = e.pageX - container2.offsetLeft;
            scrollLeftStart2 = container2.scrollLeft;
        });

        container2.addEventListener('mouseleave', () => {
            isDown2 = false;
        });

        container2.addEventListener('mouseup', () => {
            isDown2 = false;
        });

        container2.addEventListener('mousemove', (e) => {
            if (!isDown2) return;
            e.preventDefault();
            const x = e.pageX - container2.offsetLeft;
            const walk = (x - startX2) * 2;
            container2.scrollLeft = scrollLeftStart2 - walk;
        });
    }
});

// GPS è»Œè·¡åœ°åœ–åˆå§‹åŒ– (Leaflet)
{% if gps_points %}
document.addEventListener('DOMContentLoaded', function() {
    const gpsPoints = {{ gps_points_json|safe }};

    if (!gpsPoints || gpsPoints.length === 0) {
        console.warn('æ²’æœ‰ GPS æ•¸æ“šé»');
        return;
    }

    console.log(`è¼‰å…¥ ${gpsPoints.length} å€‹ GPS æ•¸æ“šé»`);

    // è¨ˆç®—åœ°åœ–ä¸­å¿ƒé»
    const lats = gpsPoints.map(p => p.latitude);
    const lngs = gpsPoints.map(p => p.longitude);
    const avgLat = lats.reduce((a, b) => a + b, 0) / lats.length;
    const avgLng = lngs.reduce((a, b) => a + b, 0) / lngs.length;

    // åˆå§‹åŒ– Leaflet åœ°åœ–
    const map = L.map('trajectory-map').setView([avgLat, avgLng], 14);

    // æ·»åŠ  OpenStreetMap åœ–å±¤
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // å‰µå»ºè»Œè·¡ç·š
    const lineCoordinates = gpsPoints.map(p => [p.latitude, p.longitude]);
    const polyline = L.polyline(lineCoordinates, {
        color: '#667eea',
        weight: 4,
        opacity: 0.8
    }).addTo(map);

    // æ·»åŠ èµ·é»å’Œçµ‚é»æ¨™è¨˜
    if (gpsPoints.length > 0) {
        const firstPoint = gpsPoints[0];
        const lastPoint = gpsPoints[gpsPoints.length - 1];

        // èµ·é»æ¨™è¨˜ï¼ˆç¶ è‰²ï¼‰
        L.circleMarker([firstPoint.latitude, firstPoint.longitude], {
            radius: 8,
            fillColor: '#28a745',
            color: '#fff',
            weight: 2,
            fillOpacity: 0.9
        }).bindPopup(`
            <div style="min-width: 200px;">
                <div style="color: #28a745; font-weight: 600; margin-bottom: 5px;">ğŸ”µ èµ·é»</div>
                <strong>{{ station.station_name }}</strong><br>
                <small>${new Date(firstPoint.timestamp).toLocaleString('zh-TW')}</small>
                <hr style="margin: 8px 0;">
                ${firstPoint.temperature !== null ? `æº«åº¦: ${firstPoint.temperature.toFixed(2)}Â°C<br>` : ''}
                ${firstPoint.ph !== null ? `pH: ${firstPoint.ph.toFixed(2)}<br>` : ''}
                ${firstPoint.oxygen !== null ? `æº¶æ°§: ${firstPoint.oxygen.toFixed(2)} mg/L<br>` : ''}
                <small>ğŸ“ ${firstPoint.latitude.toFixed(6)}, ${firstPoint.longitude.toFixed(6)}</small>
            </div>
        `).addTo(map);

        // çµ‚é»æ¨™è¨˜ï¼ˆç´…è‰²ï¼‰
        L.circleMarker([lastPoint.latitude, lastPoint.longitude], {
            radius: 10,
            fillColor: '#dc3545',
            color: '#fff',
            weight: 2,
            fillOpacity: 0.9
        }).bindPopup(`
            <div style="min-width: 200px;">
                <div style="color: #dc3545; font-weight: 600; margin-bottom: 5px;">ğŸ”´ æœ€æ–°ä½ç½®</div>
                <strong>{{ station.station_name }}</strong><br>
                <small>${new Date(lastPoint.timestamp).toLocaleString('zh-TW')}</small>
                <hr style="margin: 8px 0;">
                ${lastPoint.temperature !== null ? `æº«åº¦: ${lastPoint.temperature.toFixed(2)}Â°C<br>` : ''}
                ${lastPoint.ph !== null ? `pH: ${lastPoint.ph.toFixed(2)}<br>` : ''}
                ${lastPoint.oxygen !== null ? `æº¶æ°§: ${lastPoint.oxygen.toFixed(2)} mg/L<br>` : ''}
                <small>ğŸ“ ${lastPoint.latitude.toFixed(6)}, ${lastPoint.longitude.toFixed(6)}</small>
            </div>
        `).addTo(map);
    }

    // è‡ªå‹•èª¿æ•´è¦–åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰é»
    const bounds = L.latLngBounds(gpsPoints.map(p => [p.latitude, p.longitude]));
    map.fitBounds(bounds, { padding: [50, 50] });

    console.log('GPS è»Œè·¡åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
});
{% endif %}
</script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{% if station.latitude and station.longitude %}
<script>
// åˆå§‹åŒ–åœ°åœ–
document.addEventListener('DOMContentLoaded', function() {
    const lat = parseFloat('{{ station.latitude }}');
    const lng = parseFloat('{{ station.longitude }}');

    if (lat && lng) {
        // å‰µå»ºåœ°åœ–
        const map = L.map('stationMap').setView([lat, lng], 13);

        // æ·»åŠ  OpenStreetMap åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // æ·»åŠ æ¨™è¨˜
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup('<b>{{ station.station_name }}</b><br>{{ station.location }}').openPopup();
    }
});
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'realtime/realtime.js' %}"></script>
<script>
// å®Œæ•´çš„åƒæ•¸é…ç½®
const parameterConfig = {
    temperature: {
        label: 'æº«åº¦ (Â°C)',
        borderColor: 'rgb(220, 53, 69)',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
    },
    ph: {
        label: 'é…¸é¹¼å€¼ (pH)',
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
    },
    oxygen: {
        label: 'æº¶æ°§ (mg/L)',
        borderColor: 'rgb(25, 135, 84)',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
    },
    salinity: {
        label: 'é¹½åº¦ (PSU)',
        borderColor: 'rgb(111, 66, 193)',
        backgroundColor: 'rgba(111, 66, 193, 0.1)',
    },
    conductivity: {
        label: 'é›»å°ç‡ (mS/cm)',
        borderColor: 'rgb(253, 126, 20)',
        backgroundColor: 'rgba(253, 126, 20, 0.1)',
    },
    pressure: {
        label: 'å£“åŠ› (dbar)',
        borderColor: 'rgb(32, 201, 151)',
        backgroundColor: 'rgba(32, 201, 151, 0.1)',
    },
    fluorescence: {
        label: 'è¢å…‰å€¼ (Âµg/L)',
        borderColor: 'rgb(214, 51, 132)',
        backgroundColor: 'rgba(214, 51, 132, 0.1)',
    },
    turbidity: {
        label: 'æ¿åº¦ (NTU)',
        borderColor: 'rgb(108, 117, 125)',
        backgroundColor: 'rgba(108, 117, 125, 0.1)',
    }
};

var chartData = JSON.parse('{{ chart_data_json|escapejs }}');
var ctx = document.getElementById('dataChart').getContext('2d');

// å‰µå»ºåœ–è¡¨å¯¦ä¾‹
window.chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.labels,
        datasets: []
    },
    options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                display: true,
                position: 'top',
            },
            tooltip: {
                mode: 'index',
                intersect: false,
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'æ™‚é–“'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
            }
        }
    }
});

// æ›´æ–°åœ–è¡¨çš„å‡½æ•¸
function updateChart() {
    const checkboxes = document.querySelectorAll('.param-checkbox:checked');
    const datasets = [];

    checkboxes.forEach(checkbox => {
        const param = checkbox.dataset.param;
        const config = parameterConfig[param];

        if (config && chartData[param]) {
            datasets.push({
                label: config.label,
                data: chartData[param],
                borderColor: config.borderColor,
                backgroundColor: config.backgroundColor,
                tension: 0.1,
                borderWidth: 2,
            });
        }
    });

    window.chartInstance.data.datasets = datasets;
    window.chartInstance.update();
}

// ç›£è½ checkbox è®ŠåŒ–
document.querySelectorAll('.param-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateChart);

    // æ·»åŠ è¦–è¦ºæ•ˆæœ
    checkbox.parentElement.addEventListener('click', function(e) {
        if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            updateChart();
        }
    });
});

// åˆå§‹åŒ–åœ–è¡¨ - é¡¯ç¤ºé»˜èªé¸ä¸­çš„åƒæ•¸
updateChart();

// æ™‚é–“ç¯„åœåˆ‡æ›å‡½æ•¸ - ä½¿ç”¨ AJAX ä¸é‡æ–°è¼‰å…¥é é¢
function changeTimeRange(range) {
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
    const canvas = document.getElementById('dataChart');
    canvas.style.opacity = '0.5';

    // ä½¿ç”¨ AJAX ç²å–æ–°æ•¸æ“š
    const stationId = '{{ station.id }}';
    fetch('/stations/' + stationId + '/chart-data/?time_range=' + range)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // æ›´æ–°å…¨å±€ chartData
                chartData = data.chart_data;

                // æ›´æ–°åœ–è¡¨
                updateChart();

                // æ¢å¾©é€æ˜åº¦
                canvas.style.opacity = '1';
            }
        })
        .catch(error => {
            console.error('Error fetching chart data:', error);
            canvas.style.opacity = '1';
            alert('è¼‰å…¥åœ–è¡¨æ•¸æ“šå¤±æ•—,è«‹é‡è©¦');
        });
}

// åˆå§‹åŒ– realtime ç›£æ§æ™‚ï¼ŒæŠŠåœ–è¡¨å¯¦ä¾‹å‚³çµ¦å®ƒ
if (window.realtimeInit) {
    window.realtimeInit();
}
</script>
{% endblock %}