{% extends 'base.html' %}

{% block title %}æ•¸æ“šè¨˜éŒ„ - æµ·æ´‹ç›£æ¸¬ç³»çµ±{% endblock %}

{% block extra_head %}
<!-- Mapbox GL JS -->
<link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
<style>
    #trajectory-map {
        height: 600px;
        width: 100%;
        max-width: 100%;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .map-legend {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .map-legend h4 {
        margin: 0 0 12px 0;
        font-size: 15px;
        font-weight: 600;
        color: #2c3e50;
    }
    .map-legend-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 13px;
        color: #34495e;
    }
    .map-legend-color {
        width: 24px;
        height: 4px;
        margin-right: 10px;
        border-radius: 2px;
    }
    /* Mapbox Popup æ¨£å¼ç¾åŒ– */
    .mapboxgl-popup-content {
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .mapboxgl-popup-close-button {
        font-size: 20px;
        padding: 5px 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>å„€å™¨ç§»å‹•è»Œè·¡ & æœ€æ–°æ•¸æ“šè¨˜éŒ„</h2>

    <!-- GPS è»Œè·¡åœ°åœ– -->
    {% if gps_points %}
    <div style="width: 100%; max-width: 100%; overflow: hidden; margin-bottom: 2rem;">
        <div id="trajectory-map"></div>
    </div>
    {% else %}
    <div style="background: #f8f9fa; padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: #6c757d; margin: 0;">
            ğŸ“ å°šç„¡ GPS æ•¸æ“šã€‚è«‹å…ˆåœ¨ç®¡ç†å¾Œå°ç‚ºæ¸¬ç«™è¨­å®šç¶“ç·¯åº¦,ä¸¦ç”Ÿæˆæ–°çš„æ•¸æ“šè¨˜éŒ„ã€‚
        </p>
    </div>
    {% endif %}

    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">æ•¸æ“šè¨˜éŒ„ï¼ˆæœ€æ–° 100 ç­†ï¼‰</h3>

    <!-- æ•¸æ“šè¡¨æ ¼å®¹å™¨ -->
    <div style="position: relative; overflow: hidden;">
        <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
        <button id="scrollLeft" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0 4px 4px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">
            â—€
        </button>
        <button id="scrollRight" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 4px 0 0 4px; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            â–¶
        </button>

        <!-- å¯æ»¾å‹•çš„è¡¨æ ¼ -->
        <div id="tableContainer" style="overflow-x: auto; scroll-behavior: smooth; padding: 0 2.5rem;">
            <table style="min-width: 1400px;">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;">æ¸¬ç«™</th>
                        <th style="white-space: nowrap;">æ™‚é–“</th>
                        <th style="white-space: nowrap;">æº«åº¦ (Â°C)</th>
                        <th style="white-space: nowrap;">é…¸é¹¼å€¼</th>
                        <th style="white-space: nowrap;">æº¶æ°§ (mg/L)</th>
                        <th style="white-space: nowrap;">é¹½åº¦ (PSU)</th>
                        <th style="white-space: nowrap;">é›»å°ç‡ (mS/cm)</th>
                        <th style="white-space: nowrap;">å£“åŠ› (dbar)</th>
                        <th style="white-space: nowrap;">è¢å…‰å€¼ (Âµg/L)</th>
                        <th style="white-space: nowrap;">æ¿åº¦ (NTU)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reading in readings %}
                    <tr>
                        <td style="white-space: nowrap;"><a href="{% url 'station_data:station_detail' reading.station.id %}">{{ reading.station.station_name }}</a></td>
                        <td style="white-space: nowrap;">{{ reading.timestamp }}</td>
                        <td style="white-space: nowrap;">{{ reading.temperature|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.ph|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.oxygen|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.salinity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.conductivity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.pressure|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.fluorescence|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.turbidity|floatformat:2|default:"--" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="10" style="text-align:center; color:#999;">å°šç„¡æ•¸æ“šè¨˜éŒ„</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
        æç¤º: ä½¿ç”¨å·¦å³ç®­é ­æŒ‰éˆ•æˆ–æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ•¸æ“š
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('tableContainer');
    const leftBtn = document.getElementById('scrollLeft');
    const rightBtn = document.getElementById('scrollRight');

    if (container && leftBtn && rightBtn) {
        // å·¦å³æ»¾å‹•åŠŸèƒ½
        leftBtn.addEventListener('click', function() {
            container.scrollLeft -= 300;
        });

        rightBtn.addEventListener('click', function() {
            container.scrollLeft += 300;
        });

        // æ ¹æ“šæ»¾å‹•ä½ç½®é¡¯ç¤º/éš±è—æŒ‰éˆ•
        function updateButtons() {
            if (container.scrollLeft <= 0) {
                leftBtn.style.opacity = '0.3';
                leftBtn.style.cursor = 'default';
            } else {
                leftBtn.style.opacity = '1';
                leftBtn.style.cursor = 'pointer';
            }

            if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 10) {
                rightBtn.style.opacity = '0.3';
                rightBtn.style.cursor = 'default';
            } else {
                rightBtn.style.opacity = '1';
                rightBtn.style.cursor = 'pointer';
            }
        }

        container.addEventListener('scroll', updateButtons);
        updateButtons();

        // æ”¯æŒè§¸æ§æ»‘å‹•
        let isDown = false;
        let startX;
        let scrollLeftStart;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - container.offsetLeft;
            scrollLeftStart = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
            isDown = false;
        });

        container.addEventListener('mouseup', () => {
            isDown = false;
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2;
            container.scrollLeft = scrollLeftStart - walk;
        });
    }
});

// ==========================================
// GPS è»Œè·¡åœ°åœ–åˆå§‹åŒ– (Mapbox GL JS)
// ==========================================
{% if gps_points %}
(function() {
    // è¼‰å…¥ Mapbox GL JS
    const script = document.createElement('script');
    script.src = 'https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js';
    script.onload = function() {
        setTimeout(initTrajectoryMap, 100);
    };
    script.onerror = function() {
        console.error('ç„¡æ³•è¼‰å…¥ Mapbox GL JS');
        document.getElementById('trajectory-map').innerHTML =
            '<div style="padding: 2rem; text-align: center; color: #e74c3c;">åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
    };
    document.head.appendChild(script);

    function initTrajectoryMap() {
        const gpsPoints = {{ gps_points_json|safe }};

        if (!gpsPoints || gpsPoints.length === 0) {
            console.warn('æ²’æœ‰ GPS æ•¸æ“šé»');
            return;
        }

        console.log(`è¼‰å…¥ ${gpsPoints.length} å€‹ GPS æ•¸æ“šé»`);

        // è¨ˆç®—åœ°åœ–ä¸­å¿ƒé»å’Œé‚Šç•Œ
        const lats = gpsPoints.map(p => p.latitude);
        const lngs = gpsPoints.map(p => p.longitude);
        const avgLat = lats.reduce((a, b) => a + b, 0) / lats.length;
        const avgLng = lngs.reduce((a, b) => a + b, 0) / lngs.length;

        console.log(`åœ°åœ–ä¸­å¿ƒé»: ${avgLat}, ${avgLng}`);

        // åˆå§‹åŒ– Mapbox åœ°åœ–ï¼ˆä½¿ç”¨å…è²»çš„ OSM æ¨£å¼ï¼‰
        const map = new mapboxgl.Map({
            container: 'trajectory-map',
            style: {
                version: 8,
                sources: {
                    'osm-tiles': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm-tiles',
                    type: 'raster',
                    source: 'osm-tiles',
                    minzoom: 0,
                    maxzoom: 19
                }]
            },
            center: [avgLng, avgLat],
            zoom: 14,
            pitch: 0,
            bearing: 0
        });

        // æ·»åŠ å°èˆªæ§åˆ¶
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

        // ç­‰å¾…åœ°åœ–è¼‰å…¥å®Œæˆ
        map.on('load', function() {
            // æŒ‰æ¸¬ç«™åˆ†çµ„æ•¸æ“šé»
            const stationGroups = {};
            gpsPoints.forEach(point => {
                if (!stationGroups[point.station_name]) {
                    stationGroups[point.station_name] = [];
                }
                stationGroups[point.station_name].push(point);
            });

            // ç‚ºæ¯å€‹æ¸¬ç«™é¸æ“‡é¡è‰²
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            let colorIndex = 0;
            const legendData = [];

            // ç¹ªè£½æ¯å€‹æ¸¬ç«™çš„è»Œè·¡
            Object.keys(stationGroups).forEach(stationName => {
                const points = stationGroups[stationName];
                const color = colors[colorIndex % colors.length];

                // æŒ‰æ™‚é–“æ’åº
                points.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                // å‰µå»º GeoJSON ç·šæ¢
                const lineCoordinates = points.map(p => [p.longitude, p.latitude]);

                map.addSource(`route-${colorIndex}`, {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: lineCoordinates
                        }
                    }
                });

                map.addLayer({
                    id: `route-${colorIndex}`,
                    type: 'line',
                    source: `route-${colorIndex}`,
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': color,
                        'line-width': 4,
                        'line-opacity': 0.8
                    }
                });

                // æ·»åŠ æ¨™è¨˜é»
                points.forEach((point, index) => {
                    const isFirst = index === 0;
                    const isLast = index === points.length - 1;

                    // å‰µå»ºæ¨™è¨˜å…ƒç´ 
                    const el = document.createElement('div');
                    el.className = 'trajectory-marker';
                    el.style.backgroundColor = color;
                    el.style.width = isLast ? '16px' : '10px';
                    el.style.height = isLast ? '16px' : '10px';
                    el.style.borderRadius = '50%';
                    el.style.border = '2px solid white';
                    el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    el.style.cursor = 'pointer';

                    // Popup å…§å®¹
                    const timestamp = new Date(point.timestamp).toLocaleString('zh-TW');
                    let popupHTML = `<div style="min-width: 220px; font-family: sans-serif;">`;

                    if (isFirst) {
                        popupHTML += `<div style="color: ${color}; font-weight: 600; margin-bottom: 8px;">ğŸ”µ èµ·é»</div>`;
                    } else if (isLast) {
                        popupHTML += `<div style="color: ${color}; font-weight: 600; margin-bottom: 8px;">ğŸ”´ æœ€æ–°ä½ç½®</div>`;
                    }

                    popupHTML += `<strong style="font-size: 15px;">${stationName}</strong><br>`;
                    popupHTML += `<small style="color: #7f8c8d;">${timestamp}</small><br>`;
                    popupHTML += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #ecf0f1;">`;

                    if (point.temperature !== null) {
                        popupHTML += `<div style="margin: 5px 0;">ğŸŒ¡ï¸ æº«åº¦: <strong>${point.temperature.toFixed(2)}Â°C</strong></div>`;
                    }
                    if (point.ph !== null) {
                        popupHTML += `<div style="margin: 5px 0;">âš—ï¸ pH: <strong>${point.ph.toFixed(2)}</strong></div>`;
                    }
                    if (point.oxygen !== null) {
                        popupHTML += `<div style="margin: 5px 0;">ğŸ’¨ æº¶æ°§: <strong>${point.oxygen.toFixed(2)} mg/L</strong></div>`;
                    }

                    popupHTML += `<small style="color: #95a5a6; margin-top: 8px; display: block;">ğŸ“ ${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}</small>`;
                    popupHTML += `</div>`;

                    new mapboxgl.Marker(el)
                        .setLngLat([point.longitude, point.latitude])
                        .setPopup(new mapboxgl.Popup({ offset: 15 }).setHTML(popupHTML))
                        .addTo(map);
                });

                legendData.push({ name: stationName, color: color, count: points.length });
                colorIndex++;
            });

            // æ·»åŠ åœ–ä¾‹
            const legendDiv = document.createElement('div');
            legendDiv.className = 'map-legend';
            legendDiv.style.position = 'absolute';
            legendDiv.style.bottom = '30px';
            legendDiv.style.right = '10px';
            legendDiv.style.zIndex = '1';

            let legendHTML = '<h4>ğŸ“Š æ¸¬ç«™è»Œè·¡</h4>';
            legendData.forEach(item => {
                legendHTML += `
                    <div class="map-legend-item">
                        <div class="map-legend-color" style="background: ${item.color};"></div>
                        <span>${item.name} <small style="color: #95a5a6;">(${item.count} é»)</small></span>
                    </div>
                `;
            });

            legendDiv.innerHTML = legendHTML;
            document.getElementById('trajectory-map').appendChild(legendDiv);

            // è‡ªå‹•èª¿æ•´è¦–åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰é»
            const bounds = new mapboxgl.LngLatBounds();
            gpsPoints.forEach(p => {
                bounds.extend([p.longitude, p.latitude]);
            });

            map.fitBounds(bounds, {
                padding: { top: 50, bottom: 50, left: 50, right: 50 },
                maxZoom: 15
            });

            console.log('åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
        });
    }
})();
{% endif %}
</script>
{% endblock %}
