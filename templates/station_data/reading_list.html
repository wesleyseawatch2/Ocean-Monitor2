{% extends 'base.html' %}

{% block title %}æ•¸æ“šè¨˜éŒ„ - æµ·æ´‹ç›£æ¸¬ç³»çµ±{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />
<style>
    #trajectory-map {
        height: 600px;
        width: 100%;
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 2rem;
        border: 2px solid #e1e8ed;
        box-sizing: border-box;
        overflow: hidden;
    }
    .map-legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
    .map-legend h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
    }
    .map-legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 12px;
    }
    .map-legend-color {
        width: 20px;
        height: 3px;
        margin-right: 8px;
    }
    /* ä¿®å¾© Leaflet å¯èƒ½çš„æ¨£å¼å•é¡Œ */
    .leaflet-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>å„€å™¨ç§»å‹•è»Œè·¡ & æœ€æ–°æ•¸æ“šè¨˜éŒ„</h2>

    <!-- GPS è»Œè·¡åœ°åœ– -->
    {% if gps_points %}
    <div style="width: 100%; max-width: 100%; overflow: hidden; margin-bottom: 2rem;">
        <div id="trajectory-map"></div>
    </div>
    {% else %}
    <div style="background: #f8f9fa; padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: #6c757d; margin: 0;">
            ğŸ“ å°šç„¡ GPS æ•¸æ“šã€‚è«‹å…ˆåœ¨ç®¡ç†å¾Œå°ç‚ºæ¸¬ç«™è¨­å®šç¶“ç·¯åº¦,ä¸¦ç”Ÿæˆæ–°çš„æ•¸æ“šè¨˜éŒ„ã€‚
        </p>
    </div>
    {% endif %}

    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">æ•¸æ“šè¨˜éŒ„ï¼ˆæœ€æ–° 100 ç­†ï¼‰</h3>

    <!-- æ•¸æ“šè¡¨æ ¼å®¹å™¨ -->
    <div style="position: relative; overflow: hidden;">
        <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
        <button id="scrollLeft" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0 4px 4px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">
            â—€
        </button>
        <button id="scrollRight" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 4px 0 0 4px; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            â–¶
        </button>

        <!-- å¯æ»¾å‹•çš„è¡¨æ ¼ -->
        <div id="tableContainer" style="overflow-x: auto; scroll-behavior: smooth; padding: 0 2.5rem;">
            <table style="min-width: 1400px;">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;">æ¸¬ç«™</th>
                        <th style="white-space: nowrap;">æ™‚é–“</th>
                        <th style="white-space: nowrap;">æº«åº¦ (Â°C)</th>
                        <th style="white-space: nowrap;">é…¸é¹¼å€¼</th>
                        <th style="white-space: nowrap;">æº¶æ°§ (mg/L)</th>
                        <th style="white-space: nowrap;">é¹½åº¦ (PSU)</th>
                        <th style="white-space: nowrap;">é›»å°ç‡ (mS/cm)</th>
                        <th style="white-space: nowrap;">å£“åŠ› (dbar)</th>
                        <th style="white-space: nowrap;">è¢å…‰å€¼ (Âµg/L)</th>
                        <th style="white-space: nowrap;">æ¿åº¦ (NTU)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reading in readings %}
                    <tr>
                        <td style="white-space: nowrap;"><a href="{% url 'station_data:station_detail' reading.station.id %}">{{ reading.station.station_name }}</a></td>
                        <td style="white-space: nowrap;">{{ reading.timestamp }}</td>
                        <td style="white-space: nowrap;">{{ reading.temperature|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.ph|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.oxygen|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.salinity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.conductivity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.pressure|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.fluorescence|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.turbidity|floatformat:2|default:"--" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="10" style="text-align:center; color:#999;">å°šç„¡æ•¸æ“šè¨˜éŒ„</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
        æç¤º: ä½¿ç”¨å·¦å³ç®­é ­æŒ‰éˆ•æˆ–æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ•¸æ“š
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('tableContainer');
    const leftBtn = document.getElementById('scrollLeft');
    const rightBtn = document.getElementById('scrollRight');

    if (container && leftBtn && rightBtn) {
        // å·¦å³æ»¾å‹•åŠŸèƒ½
        leftBtn.addEventListener('click', function() {
            container.scrollLeft -= 300;
        });

        rightBtn.addEventListener('click', function() {
            container.scrollLeft += 300;
        });

        // æ ¹æ“šæ»¾å‹•ä½ç½®é¡¯ç¤º/éš±è—æŒ‰éˆ•
        function updateButtons() {
            if (container.scrollLeft <= 0) {
                leftBtn.style.opacity = '0.3';
                leftBtn.style.cursor = 'default';
            } else {
                leftBtn.style.opacity = '1';
                leftBtn.style.cursor = 'pointer';
            }

            if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 10) {
                rightBtn.style.opacity = '0.3';
                rightBtn.style.cursor = 'default';
            } else {
                rightBtn.style.opacity = '1';
                rightBtn.style.cursor = 'pointer';
            }
        }

        container.addEventListener('scroll', updateButtons);
        updateButtons();

        // æ”¯æŒè§¸æ§æ»‘å‹•
        let isDown = false;
        let startX;
        let scrollLeftStart;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - container.offsetLeft;
            scrollLeftStart = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
            isDown = false;
        });

        container.addEventListener('mouseup', () => {
            isDown = false;
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2;
            container.scrollLeft = scrollLeftStart - walk;
        });
    }
});

// ==========================================
// GPS è»Œè·¡åœ°åœ–åˆå§‹åŒ–
// ==========================================
{% if gps_points %}
(function() {
    // Leaflet JS
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
    script.crossOrigin = '';
    script.onload = function() {
        // å»¶é²åŸ·è¡Œç¢ºä¿ DOM å’Œ Leaflet å®Œå…¨è¼‰å…¥
        setTimeout(initTrajectoryMap, 100);
    };
    script.onerror = function() {
        console.error('ç„¡æ³•è¼‰å…¥ Leaflet.js');
        document.getElementById('trajectory-map').innerHTML = '<div style="padding: 2rem; text-align: center; color: #e74c3c;">åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
    };
    document.head.appendChild(script);

    function initTrajectoryMap() {
        const gpsPoints = {{ gps_points_json|safe }};

        if (!gpsPoints || gpsPoints.length === 0) {
            console.warn('æ²’æœ‰ GPS æ•¸æ“šé»');
            return;
        }

        console.log(`è¼‰å…¥ ${gpsPoints.length} å€‹ GPS æ•¸æ“šé»`);

        // è¨ˆç®—åœ°åœ–ä¸­å¿ƒé»
        const avgLat = gpsPoints.reduce((sum, p) => sum + p.latitude, 0) / gpsPoints.length;
        const avgLng = gpsPoints.reduce((sum, p) => sum + p.longitude, 0) / gpsPoints.length;

        console.log(`åœ°åœ–ä¸­å¿ƒé»: ${avgLat}, ${avgLng}`);

        // åˆå§‹åŒ–åœ°åœ–
        const map = L.map('trajectory-map', {
            center: [avgLat, avgLng],
            zoom: 14,
            zoomControl: true,
            scrollWheelZoom: true
        });

        // ä½¿ç”¨ OpenStreetMap åœ–è³‡
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // æŒ‰æ¸¬ç«™åˆ†çµ„æ•¸æ“šé»
        const stationGroups = {};
        gpsPoints.forEach(point => {
            if (!stationGroups[point.station_name]) {
                stationGroups[point.station_name] = [];
            }
            stationGroups[point.station_name].push(point);
        });

        // ç‚ºæ¯å€‹æ¸¬ç«™é¸æ“‡é¡è‰²
        const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
        let colorIndex = 0;

        // ç¹ªè£½æ¯å€‹æ¸¬ç«™çš„è»Œè·¡
        Object.keys(stationGroups).forEach(stationName => {
            const points = stationGroups[stationName];
            const color = colors[colorIndex % colors.length];
            colorIndex++;

            // æŒ‰æ™‚é–“æ’åº
            points.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // ç¹ªè£½è»Œè·¡ç·š
            const latLngs = points.map(p => [p.latitude, p.longitude]);
            const polyline = L.polyline(latLngs, {
                color: color,
                weight: 3,
                opacity: 0.7
            }).addTo(map);

            // ç‚ºæ¯å€‹é»æ·»åŠ æ¨™è¨˜
            points.forEach((point, index) => {
                const isFirst = index === 0;
                const isLast = index === points.length - 1;

                const marker = L.circleMarker([point.latitude, point.longitude], {
                    radius: isLast ? 8 : 5,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: isLast ? 1 : 0.7
                }).addTo(map);

                // Popup å…§å®¹
                const timestamp = new Date(point.timestamp).toLocaleString('zh-TW');
                let popupContent = `
                    <div style="min-width: 200px;">
                        <strong>${stationName}</strong><br>
                        <small>${timestamp}</small><br>
                        <hr style="margin: 5px 0;">
                `;

                if (point.temperature !== null) {
                    popupContent += `æº«åº¦: ${point.temperature.toFixed(2)}Â°C<br>`;
                }
                if (point.ph !== null) {
                    popupContent += `pH: ${point.ph.toFixed(2)}<br>`;
                }
                if (point.oxygen !== null) {
                    popupContent += `æº¶æ°§: ${point.oxygen.toFixed(2)} mg/L<br>`;
                }

                popupContent += `<small>ä½ç½®: ${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}</small>`;

                if (isFirst) {
                    popupContent = `<div style="color: ${color};">ğŸ”µ èµ·é»</div>` + popupContent;
                } else if (isLast) {
                    popupContent = `<div style="color: ${color};">ğŸ”´ æœ€æ–°ä½ç½®</div>` + popupContent;
                }

                popupContent += `</div>`;
                marker.bindPopup(popupContent);
            });
        });

        // æ·»åŠ åœ–ä¾‹
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = '<h4>æ¸¬ç«™è»Œè·¡</h4>';

            let legendColorIndex = 0;
            Object.keys(stationGroups).forEach(stationName => {
                const color = colors[legendColorIndex % colors.length];
                legendColorIndex++;
                div.innerHTML += `
                    <div class="map-legend-item">
                        <div class="map-legend-color" style="background: ${color};"></div>
                        <span>${stationName} (${stationGroups[stationName].length} é»)</span>
                    </div>
                `;
            });

            return div;
        };
        legend.addTo(map);

        // è‡ªå‹•èª¿æ•´è¦–åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰é»
        const bounds = L.latLngBounds(gpsPoints.map(p => [p.latitude, p.longitude]));
        map.fitBounds(bounds, { padding: [50, 50] });

        // å¼·åˆ¶é‡æ–°è¨ˆç®—åœ°åœ–å°ºå¯¸
        setTimeout(function() {
            map.invalidateSize();
            console.log('åœ°åœ–å°ºå¯¸å·²é‡æ–°è¨ˆç®—');
        }, 200);
    }
})();
{% endif %}
</script>
{% endblock %}
