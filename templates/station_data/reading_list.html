{% extends 'base.html' %}

{% block title %}æ•¸æ“šè¨˜éŒ„ - Ocean Monitor Web{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #trajectory-map {
        height: 600px;
        width: 100%;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .map-legend {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .map-legend h4 {
        margin: 0 0 12px 0;
        font-size: 15px;
        font-weight: 600;
        color: #2c3e50;
    }
    .map-legend-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 13px;
    }
    .map-legend-color {
        width: 24px;
        height: 4px;
        margin-right: 10px;
        border-radius: 2px;
    }
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>å„€å™¨ç§»å‹•è»Œè·¡ & æœ€æ–°æ•¸æ“šè¨˜éŒ„</h2>

    <!-- GPS è»Œè·¡åœ°åœ– -->
    {% if gps_points %}
    <div style="width: 100%; max-width: 100%; overflow: hidden; margin-bottom: 2rem;">
        <div id="trajectory-map"></div>
    </div>
    {% else %}
    <div style="background: #f8f9fa; padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: #6c757d; margin: 0;">
            ğŸ“ å°šç„¡ GPS æ•¸æ“šã€‚è«‹å…ˆåœ¨ç®¡ç†å¾Œå°ç‚ºæ¸¬ç«™è¨­å®šç¶“ç·¯åº¦,ä¸¦ç”Ÿæˆæ–°çš„æ•¸æ“šè¨˜éŒ„ã€‚
        </p>
    </div>
    {% endif %}

    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">æ•¸æ“šè¨˜éŒ„ï¼ˆæœ€æ–° 100 ç­†ï¼‰</h3>

    <!-- æ•¸æ“šè¡¨æ ¼å®¹å™¨ -->
    <div style="position: relative; overflow: hidden;">
        <!-- å·¦å³åˆ‡æ›æŒ‰éˆ• -->
        <button id="scrollLeft" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 0 4px 4px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">
            â—€
        </button>
        <button id="scrollRight" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: rgba(255,255,255,0.9); border: 1px solid #dee2e6; padding: 1rem 0.5rem; cursor: pointer; border-radius: 4px 0 0 4px; box-shadow: -2px 0 5px rgba(0,0,0,0.1);">
            â–¶
        </button>

        <!-- å¯æ»¾å‹•çš„è¡¨æ ¼ -->
        <div id="tableContainer" style="overflow-x: auto; scroll-behavior: smooth; padding: 0 2.5rem;">
            <table style="min-width: 1400px;">
                <thead>
                    <tr>
                        <th style="white-space: nowrap;">æ¸¬ç«™</th>
                        <th style="white-space: nowrap;">æ™‚é–“</th>
                        <th style="white-space: nowrap;">æº«åº¦ (Â°C)</th>
                        <th style="white-space: nowrap;">é…¸é¹¼å€¼</th>
                        <th style="white-space: nowrap;">æº¶æ°§ (mg/L)</th>
                        <th style="white-space: nowrap;">é¹½åº¦ (PSU)</th>
                        <th style="white-space: nowrap;">é›»å°ç‡ (mS/cm)</th>
                        <th style="white-space: nowrap;">å£“åŠ› (dbar)</th>
                        <th style="white-space: nowrap;">è¢å…‰å€¼ (Âµg/L)</th>
                        <th style="white-space: nowrap;">æ¿åº¦ (NTU)</th>
                    </tr>
                </thead>
                <tbody id="readings-tbody">
                    {% for reading in readings %}
                    <tr>
                        <td style="white-space: nowrap;"><a href="{% url 'station_data:station_detail' reading.station.id %}">{{ reading.station.station_name }}</a></td>
                        <td style="white-space: nowrap;">{{ reading.timestamp }}</td>
                        <td style="white-space: nowrap;">{{ reading.temperature|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.ph|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.oxygen|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.salinity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.conductivity|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.pressure|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.fluorescence|floatformat:2|default:"--" }}</td>
                        <td style="white-space: nowrap;">{{ reading.turbidity|floatformat:2|default:"--" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="10" style="text-align:center; color:#999;">å°šç„¡æ•¸æ“šè¨˜éŒ„</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
        æç¤º: ä½¿ç”¨å·¦å³ç®­é ­æŒ‰éˆ•æˆ–æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ•¸æ“š
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('tableContainer');
    const leftBtn = document.getElementById('scrollLeft');
    const rightBtn = document.getElementById('scrollRight');

    if (container && leftBtn && rightBtn) {
        // å·¦å³æ»¾å‹•åŠŸèƒ½
        leftBtn.addEventListener('click', function() {
            container.scrollLeft -= 300;
        });

        rightBtn.addEventListener('click', function() {
            container.scrollLeft += 300;
        });

        // æ ¹æ“šæ»¾å‹•ä½ç½®é¡¯ç¤º/éš±è—æŒ‰éˆ•
        function updateButtons() {
            if (container.scrollLeft <= 0) {
                leftBtn.style.opacity = '0.3';
                leftBtn.style.cursor = 'default';
            } else {
                leftBtn.style.opacity = '1';
                leftBtn.style.cursor = 'pointer';
            }

            if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 10) {
                rightBtn.style.opacity = '0.3';
                rightBtn.style.cursor = 'default';
            } else {
                rightBtn.style.opacity = '1';
                rightBtn.style.cursor = 'pointer';
            }
        }

        container.addEventListener('scroll', updateButtons);
        updateButtons();

        // æ”¯æŒè§¸æ§æ»‘å‹•
        let isDown = false;
        let startX;
        let scrollLeftStart;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - container.offsetLeft;
            scrollLeftStart = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
            isDown = false;
        });

        container.addEventListener('mouseup', () => {
            isDown = false;
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2;
            container.scrollLeft = scrollLeftStart - walk;
        });
    }

    // ==========================================
    // å®šæœŸåˆ·æ–°æ•¸æ“šè¨˜éŒ„åˆ—è¡¨ (æ¯ 30 ç§’)
    // ==========================================
    function refreshReadingsList() {
        const tbody = document.getElementById('readings-tbody');
        if (!tbody) {
            console.warn('[åˆ·æ–°] æ‰¾ä¸åˆ° readings-tbody å…ƒç´ ');
            return;
        }

        fetch('/stations/readings/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTbody = doc.getElementById('readings-tbody');

                if (!newTbody) {
                    console.warn('[åˆ·æ–°] ç„¡æ³•å¾æ–°é é¢æ‰¾åˆ° tbody');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰æ–°æ•¸æ“šï¼ˆæ¯”è¼ƒç¬¬ä¸€è¡Œï¼‰
                const oldFirstRow = tbody.querySelector('tr:first-child');
                const newFirstRow = newTbody.querySelector('tr:first-child');

                let hasNewData = false;
                if (oldFirstRow && newFirstRow) {
                    const oldText = oldFirstRow.textContent.trim();
                    const newText = newFirstRow.textContent.trim();
                    hasNewData = (oldText !== newText);
                }

                // æ›´æ–°è¡¨æ ¼å…§å®¹
                tbody.innerHTML = newTbody.innerHTML;

                // å¦‚æœæœ‰æ–°æ•¸æ“šï¼Œæ·»åŠ é»ƒè‰²é–ƒçˆæ•ˆæœ
                if (hasNewData) {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        if (index < 3) {  // åªé–ƒçˆå‰ 3 ç­†
                            row.style.transition = 'background-color 0.3s ease';
                            row.style.backgroundColor = '#ffd54f';
                            setTimeout(() => {
                                row.style.backgroundColor = '';
                            }, 1500);
                        }
                    });
                    console.log('[åˆ·æ–°] æ•¸æ“šè¨˜éŒ„åˆ—è¡¨å·²æ›´æ–° (æœ‰æ–°æ•¸æ“š)');
                } else {
                    console.log('[åˆ·æ–°] æ•¸æ“šè¨˜éŒ„åˆ—è¡¨å·²æª¢æŸ¥ (ç„¡æ–°æ•¸æ“š)');
                }
            })
            .catch(error => {
                console.error('[åˆ·æ–°] æ›´æ–°å¤±æ•—:', error);
            });
    }

    // å•Ÿå‹•å®šæœŸåˆ·æ–°ï¼ˆæ¯ 30 ç§’ï¼‰
    setInterval(refreshReadingsList, 30000);
    console.log('[åˆ·æ–°] æ•¸æ“šè¨˜éŒ„åˆ—è¡¨å®šæœŸåˆ·æ–°å·²å•Ÿå‹•ï¼ˆæ¯ 30 ç§’ï¼‰');
});

// ==========================================
// GPS è»Œè·¡åœ°åœ–åˆå§‹åŒ– (Leaflet)
// ==========================================
{% if gps_points %}
document.addEventListener('DOMContentLoaded', function() {
    const gpsPoints = {{ gps_points_json|safe }};

    if (!gpsPoints || gpsPoints.length === 0) {
        console.warn('æ²’æœ‰ GPS æ•¸æ“šé»');
        return;
    }

    console.log(`è¼‰å…¥ ${gpsPoints.length} å€‹ GPS æ•¸æ“šé»`);

    // è¨ˆç®—åœ°åœ–ä¸­å¿ƒé»
    const lats = gpsPoints.map(p => p.latitude);
    const lngs = gpsPoints.map(p => p.longitude);
    const avgLat = lats.reduce((a, b) => a + b, 0) / lats.length;
    const avgLng = lngs.reduce((a, b) => a + b, 0) / lngs.length;

    // åˆå§‹åŒ– Leaflet åœ°åœ–
    const map = L.map('trajectory-map').setView([avgLat, avgLng], 15);

    // æ·»åŠ  OpenStreetMap åœ–å±¤
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // æŒ‰æ¸¬ç«™åˆ†çµ„æ•¸æ“šé»
    const stationGroups = {};
    gpsPoints.forEach(point => {
        if (!stationGroups[point.station_name]) {
            stationGroups[point.station_name] = [];
        }
        stationGroups[point.station_name].push(point);
    });

    // ç‚ºæ¯å€‹æ¸¬ç«™é¸æ“‡é¡è‰²
    const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
    let colorIndex = 0;
    const legendData = [];

    // ç¹ªè£½æ¯å€‹æ¸¬ç«™çš„è»Œè·¡
    Object.keys(stationGroups).forEach(stationName => {
        const points = stationGroups[stationName];
        const color = colors[colorIndex % colors.length];

        // æŒ‰æ™‚é–“æ’åº
        points.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        // å‰µå»ºè»Œè·¡ç·š
        const lineCoordinates = points.map(p => [p.latitude, p.longitude]);
        L.polyline(lineCoordinates, {
            color: color,
            weight: 4,
            opacity: 0.8
        }).addTo(map);

        // æ·»åŠ æ¨™è¨˜é»ï¼ˆåªé¡¯ç¤ºèµ·é»å’Œçµ‚é»ï¼‰
        points.forEach((point, index) => {
            const isFirst = index === 0;
            const isLast = index === points.length - 1;

            if (isFirst || isLast) {
                // Popup å…§å®¹
                const timestamp = new Date(point.timestamp).toLocaleString('zh-TW');
                let popupHTML = `<div style="min-width: 200px;">`;

                if (isFirst) {
                    popupHTML += `<div style="color: ${color}; font-weight: 600; margin-bottom: 5px;">ğŸ”µ èµ·é»</div>`;
                } else if (isLast) {
                    popupHTML += `<div style="color: ${color}; font-weight: 600; margin-bottom: 5px;">ğŸ”´ æœ€æ–°ä½ç½®</div>`;
                }

                popupHTML += `<strong>${stationName}</strong><br>`;
                popupHTML += `<small>${timestamp}</small><hr style="margin: 8px 0;">`;

                if (point.temperature !== null) {
                    popupHTML += `æº«åº¦: ${point.temperature.toFixed(2)}Â°C<br>`;
                }
                if (point.ph !== null) {
                    popupHTML += `pH: ${point.ph.toFixed(2)}<br>`;
                }
                if (point.oxygen !== null) {
                    popupHTML += `æº¶æ°§: ${point.oxygen.toFixed(2)} mg/L<br>`;
                }

                popupHTML += `<small>ğŸ“ ${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}</small>`;
                popupHTML += `</div>`;

                L.circleMarker([point.latitude, point.longitude], {
                    radius: isLast ? 8 : 6,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.9
                }).bindPopup(popupHTML).addTo(map);
            }
        });

        legendData.push({ name: stationName, color: color, count: points.length });
        colorIndex++;
    });

    // æ·»åŠ åœ–ä¾‹
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'map-legend');
        div.innerHTML = '<h4>ğŸ“Š æ¸¬ç«™è»Œè·¡</h4>';
        legendData.forEach(item => {
            div.innerHTML += `
                <div class="map-legend-item">
                    <div class="map-legend-color" style="background: ${item.color};"></div>
                    <span>${item.name} (${item.count} é»)</span>
                </div>
            `;
        });
        return div;
    };
    legend.addTo(map);

    // è‡ªå‹•èª¿æ•´è¦–åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰é»
    const bounds = L.latLngBounds(gpsPoints.map(p => [p.latitude, p.longitude]));
    map.fitBounds(bounds, { padding: [50, 50] });

    console.log('åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
});
{% endif %}
</script>
{% endblock %}
